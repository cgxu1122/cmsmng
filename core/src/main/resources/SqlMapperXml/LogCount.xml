<?xml version="1.0" encoding="UTF8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.ifhz.core.mapper.LogCountMapper">
    <sql id="TABLE_NAME">TY_LOG_COUNT</sql>
    <resultMap id="LogCountResultMap" type="com.ifhz.core.po.LogCount">
        <id column="LOG_COUNT_ID" property="id" jdbcType="BIGINT"/>
        <result column="MODLE_NAME" property="modleName" jdbcType="VARCHAR"/>
        <result column="CHANNEL_ID" property="channelId" jdbcType="BIGINT"/>
        <result column="DEVICE_CODE" property="deviceCode" jdbcType="VARCHAR"/>
        <result column="GROUP_ID" property="groupId" jdbcType="BIGINT"/>
        <result column="BATCH_CODE" property="batchCode" jdbcType="VARCHAR"/>
        <result column="COUNT_TIME" property="countTime" jdbcType="TIMESTAMP"/>
        <result column="PROCESS_KEY" property="processKey" jdbcType="VARCHAR"/>
        <result column="LAOWU_ID" property="laowuId" jdbcType="BIGINT"/>
        <result column="PROCESS_DAY_COUNT" property="processDayCount" jdbcType="BIGINT"/>
        <result column="DEVICE_UPLOAD_DAY_COUNT" property="deviceUploadDayCount" jdbcType="BIGINT"/>
        <result column="COUNTER_UPLOAD_DAY_COUNT" property="counterUploadDayCount" jdbcType="BIGINT"/>
        <result column="ALLCOUNT" property="allCount" jdbcType="BIGINT"/>
        <result column="ACTIVE_COUNT" property="activeCount" jdbcType="BIGINT"/>
        <result column="NONACTIVE_COUNT" property="nonActiveCount" jdbcType="BIGINT"/>
        <result column="NONACTIVE_UNINSTALL_COUNT" property="nonActiveUninstallCount" jdbcType="BIGINT"/>
        <result column="NONACTIVE_REPLACE_COUNT" property="nonActiveReplaceCount" jdbcType="BIGINT"/>

    </resultMap>

    <select id="getById" parameterType="long" resultMap="LogCountResultMap">
        select * from
        <include refid="TABLE_NAME"/>
        where LOG_COUNT_ID = #{id}
    </select>
    <select id="getByProcessKey" parameterType="string" resultMap="LogCountResultMap">
        select * from
        <include refid="TABLE_NAME"/>
        where PROCESS_KEY = #{processKey}
    </select>
    <insert id="insert" parameterType="com.ifhz.core.po.LogCount">
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            SELECT SEQ_TY_LOG_COUNT.CURRVAL FROM DUAL
        </selectKey>
        insert into TY_LOG_COUNT (LOG_COUNT_ID,
        MODLE_NAME,CHANNEL_ID,DEVICE_CODE,GROUP_ID,BATCH_CODE,PROCESS_KEY,LAOWU_ID,COUNT_TIME,
        PROCESS_DAY_COUNT,DEVICE_UPLOAD_DAY_COUNT,COUNTER_UPLOAD_DAY_COUNT,ALLCOUNT,ACTIVE_COUNT,NONACTIVE_COUNT,NONACTIVE_UNINSTALL_COUNT,NONACTIVE_REPLACE_COUNT)
        values (SEQ_TY_LOG_COUNT.NEXTVAL, #{modleName},#{channelId},#{deviceCode},#{groupId},
        #{batchCode},#{processKey},#{laowuId,jdbcType=BIGINT},#{countTime,jdbcType=TIMESTAMP},
        #{processDayCount},#{deviceUploadDayCount},#{counterUploadDayCount},#{allCount},#{activeCount},#{nonActiveCount},#{nonActiveUninstallCount},#{nonActiveReplaceCount}
        )
    </insert>
    <update id="update" parameterType="com.ifhz.core.po.LogCount">
        update
        <include refid="TABLE_NAME"/>
        <set>
            <if test="modleName != null">
                MODLE_NAME = #{modleName},
            </if>
            <if test="channelId != null">
                CHANNEL_ID = #{channelId},
            </if>
            <if test="deviceCode != null">
                DEVICE_CODE = #{deviceCode},
            </if>
            <if test="groupId != null">
                GROUP_ID = #{groupId},
            </if>
            <if test="batchCode != null">
                BATCH_CODE = #{batchCode},
            </if>
            <if test="processKey != null">
                PROCESS_KEY = #{processKey},
            </if>
            <if test="laowuId != null">
                LAOWU_ID = #{laowuId},
            </if>
            <if test="countTime != null">
                COUNT_TIME = #{countTime},
            </if>
            <if test="processDayCount != null">
                PROCESS_DAY_COUNT = #{processDayCount},
            </if>
            <if test="deviceUploadDayCount != null">
                DEVICE_UPLOAD_DAY_COUNT = #{deviceUploadDayCount},
            </if>
            <if test="counterUploadDayCount != null">
                COUNTER_UPLOAD_DAY_COUNT = #{counterUploadDayCount},
            </if>
            <if test="allCount != null">
                ALLCOUNT = #{allCount},
            </if>
            <if test="activeCount != null">
                ACTIVE_COUNT = #{activeCount},
            </if>
            <if test="nonActiveCount != null">
                NONACTIVE_COUNT = #{nonActiveCount},
            </if>
            <if test="nonActiveUninstallCount != null">
                NONACTIVE_UNINSTALL_COUNT = #{nonActiveUninstallCount},
            </if>
            <if test="nonActiveReplaceCount != null">
                NONACTIVE_REPLACE_COUNT = #{nonActiveReplaceCount},
            </if>
        </set>
        where LOG_COUNT_ID = #{id}
    </update>
    <insert id="batchInsert" useGeneratedKeys="true" parameterType="java.util.List">
        <selectKey resultType="long" keyProperty="id" order="BEFORE">
            SELECT SEQ_TY_LOG_COUNT.NEXTVAL FROM DUAL
        </selectKey>
        insert into TY_LOG_COUNT
        ( LOG_COUNT_ID,
        MODLE_NAME,
        CHANNEL_ID,
        DEVICE_CODE,
        GROUP_ID,
        BATCH_CODE,
        COUNT_TIME,
        PROCESS_KEY,
        LAOWU_ID,
        PROCESS_DAY_COUNT,
        DEVICE_UPLOAD_DAY_COUNT,
        COUNTER_UPLOAD_DAY_COUNT,
        ALLCOUNT,
        ACTIVE_COUNT,
        NONACTIVE_COUNT,
        NONACTIVE_UNINSTALL_COUNT,
        NONACTIVE_REPLACE_COUNT
        ) select SEQ_TY_LOG_COUNT.NEXTVAL,A.* from(
        <foreach collection="list" item="item" index="index" separator="UNION ALL">
            SELECT
            #{item.modleName},
            #{item.channelId},
            #{item.deviceCode},
            #{item.groupId},
            #{item.batchCode},
            #{item.countTime},
            #{item.processKey},
            #{item.laowuId},
            #{item.processDayCount},
            #{item.deviceUploadDayCount},
            #{item.counterUploadDayCount},
            #{item.allCount},
            #{item.activeCount},
            #{item.nonActiveCount},
            #{item.nonActiveUninstallCount},
            #{item.nonActiveReplaceCount}
            from dual
        </foreach>) A
    </insert>
    <resultMap id="hmap" type="java.util.HashMap">
        <result column="modle_name" property="modleName" jdbcType="VARCHAR"/>
        <result column="device_code" property="deviceCode" jdbcType="VARCHAR"/>
        <result column="CHANNEL_NAME" property="channelName" jdbcType="VARCHAR"/>
        <result column="CHANNEL_ID" property="channelId" jdbcType="BIGINT"/>
        <result column="count_time" property="countTime" jdbcType="TIMESTAMP"/>
        <result column="processDayCount" property="processDayCount" jdbcType="BIGINT"/>
        <result column="deviceUploadDayCount" property="deviceUploadDayCount" jdbcType="BIGINT"/>
        <result column="counterUploadDayCount" property="counterUploadDayCount" jdbcType="BIGINT"/>
        <result column="allCount" property="allCount" jdbcType="BIGINT"/>
        <result column="activeCount" property="activeCount" jdbcType="BIGINT"/>
        <result column="nonActiveCount" property="nonActiveCount" jdbcType="BIGINT"/>
        <result column="nonActiveUninstallCount" property="nonActiveUninstallCount" jdbcType="BIGINT"/>
        <result column="nonActiveReplaceCount" property="nonActiveReplaceCount" jdbcType="BIGINT"/>
    </resultMap>
    <select id="partnerQuery" parameterType="map" resultMap="hmap">
        select t.COUNT_TIME,t.DEVICE_CODE,t.MODLE_NAME,t.CHANNEL_ID,ci.CHANNEL_NAME,sum(t.PROCESS_DAY_COUNT) as
        processDayCount from
        TY_LOG_COUNT t LEFT OUTER JOIN TY_CHANNEL_INFO ci on t.CHANNEL_ID = ci.CHANNEL_ID
        where 1=1
        <if test="record.groupId != null and record.groupId != ''">
            and t.GROUP_ID = #{record.groupId,jdbcType=BIGINT}
        </if>
        <if test="record.modleName != null and record.modleName != ''">
            and t.MODLE_NAME = #{record.modleName,jdbcType=VARCHAR}
        </if>
        <if test="record.startDate != null and record.startDate != ''">
            <![CDATA[  and  t.COUNT_TIME >= #{record.startDate,jdbcType=TIMESTAMP}  ]]>
        </if>
        <if test="record.endDate != null and record.endDate != ''">
            <![CDATA[  and t.COUNT_TIME <= #{record.endDate,jdbcType=TIMESTAMP} ]]>
        </if>
        group by t.COUNT_TIME ,t.DEVICE_CODE,t.MODLE_NAME,t.CHANNEL_ID,ci.CHANNEL_NAME
    </select>
    <select id="partnerCPQuery" parameterType="map" resultMap="hmap">
        select t.COUNT_TIME,t.MODLE_NAME,sum(t.PROCESS_DAY_COUNT) as processDayCount from
        TY_LOG_COUNT t where 1=1
        <if test="record.groupId != null and record.groupId != ''">
            and t.GROUP_ID = #{record.groupId,jdbcType=BIGINT}
        </if>
        <if test="record.modleName != null and record.modleName != ''">
            and t.MODLE_NAME = #{record.modleName,jdbcType=VARCHAR}
        </if>
        <if test="record.startDate != null and record.startDate != ''">
            <![CDATA[  and  t.COUNT_TIME >= #{record.startDate,jdbcType=TIMESTAMP}  ]]>
        </if>
        <if test="record.endDate != null and record.endDate != ''">
            <![CDATA[  and t.COUNT_TIME <= #{record.endDate,jdbcType=TIMESTAMP} ]]>
        </if>
        group by t.COUNT_TIME ,t.MODLE_NAME
    </select>
    <select id="partnerLaowuQueryList" parameterType="map" resultMap="hmap">
        select t.COUNT_TIME,t.DEVICE_CODE,t.MODLE_NAME,sum(t.PROCESS_DAY_COUNT) as processDayCount from
        TY_LOG_COUNT t where t.LAOWU_ID is not null and t.GROUP_ID=2
        <if test="record.channelId != null and record.channelId != ''">
            and t.CHANNEL_ID = #{record.channelId,jdbcType=BIGINT}
        </if>
        <if test="record.modleName != null and record.modleName != ''">
            and t.MODLE_NAME = #{record.modleName,jdbcType=VARCHAR}
        </if>
        <if test="record.startDate != null and record.startDate != ''">
            <![CDATA[  and  t.COUNT_TIME >= #{record.startDate,jdbcType=TIMESTAMP}  ]]>
        </if>
        <if test="record.endDate != null and record.endDate != ''">
            <![CDATA[  and t.COUNT_TIME <= #{record.endDate,jdbcType=TIMESTAMP} ]]>
        </if>
        group by t.COUNT_TIME ,t.DEVICE_CODE,t.MODLE_NAME
    </select>
    <select id="warehouseQueryList" parameterType="map" resultMap="hmap">
        select t.COUNT_TIME,t.MODLE_NAME,t.CHANNEL_ID,ci.CHANNEL_NAME,
        sum(t.PROCESS_DAY_COUNT) as processDayCount,
        sum(t.ALLCOUNT) as allCount,
        sum(t.ACTIVE_COUNT) as activeCount,
        sum(t.NONACTIVE_COUNT) as nonActiveCount,
        sum(t.NONACTIVE_UNINSTALL_COUNT) as nonActiveUninstallCount,
        sum(t.NONACTIVE_REPLACE_COUNT) as nonActiveReplaceCount,
        sum(t.DEVICE_UPLOAD_DAY_COUNT) as deviceUploadDayCount,
        sum(t.COUNTER_UPLOAD_DAY_COUNT) as counterUploadDayCount
        from TY_LOG_COUNT t LEFT OUTER JOIN TY_CHANNEL_INFO ci on t.CHANNEL_ID = ci.CHANNEL_ID
        where 1=1
        <if test="record.groupId != null and record.groupId != ''">
            and t.GROUP_ID = #{record.groupId,jdbcType=BIGINT}
        </if>
        <if test="record.modleName != null and record.modleName != ''">
            and t.MODLE_NAME = #{record.modleName,jdbcType=VARCHAR}
        </if>
        <if test="record.startDate != null and record.startDate != ''">
            <![CDATA[  and  t.COUNT_TIME >= #{record.startDate,jdbcType=TIMESTAMP}  ]]>
        </if>
        <if test="record.endDate != null and record.endDate != ''">
            <![CDATA[  and t.COUNT_TIME <= #{record.endDate,jdbcType=TIMESTAMP} ]]>
        </if>
        <if test="record.channelId != null and record.channelId != ''">
            and t.CHANNEL_ID = #{record.channelId,jdbcType=BIGINT}
        </if>
        group by t.COUNT_TIME ,t.MODLE_NAME,t.CHANNEL_ID,ci.CHANNEL_NAME
    </select>

</mapper>